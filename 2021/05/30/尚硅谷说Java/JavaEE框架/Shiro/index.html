<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"plumv.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="Shiro是一个针对用户权限管理和登录的框架。横跨JSTL标签，控制层和业务层。可以和Spring进行集成。具有缓存功能，会话功能。 Shiro对于用户的权限和认证都是自动的。">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro框架">
<meta property="og:url" content="https://plumv.github.io/2021/05/30/%E5%B0%9A%E7%A1%85%E8%B0%B7%E8%AF%B4Java/JavaEE%E6%A1%86%E6%9E%B6/Shiro/index.html">
<meta property="og:site_name" content="李川的个人博客">
<meta property="og:description" content="Shiro是一个针对用户权限管理和登录的框架。横跨JSTL标签，控制层和业务层。可以和Spring进行集成。具有缓存功能，会话功能。 Shiro对于用户的权限和认证都是自动的。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207.png">
<meta property="og:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-1.png">
<meta property="og:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-2.png">
<meta property="og:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-3.png">
<meta property="og:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-4.png">
<meta property="og:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-5.png">
<meta property="og:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-6.png">
<meta property="og:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210530171033.png">
<meta property="og:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210530171033-1.png">
<meta property="article:published_time" content="2021-05-29T16:00:00.000Z">
<meta property="article:modified_time" content="2021-05-30T09:13:30.726Z">
<meta property="article:author" content="Plum Reiver">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207.png">

<link rel="canonical" href="https://plumv.github.io/2021/05/30/%E5%B0%9A%E7%A1%85%E8%B0%B7%E8%AF%B4Java/JavaEE%E6%A1%86%E6%9E%B6/Shiro/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Shiro框架 | 李川的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">李川的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">学习生活</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>日志</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://plumv.github.io/2021/05/30/%E5%B0%9A%E7%A1%85%E8%B0%B7%E8%AF%B4Java/JavaEE%E6%A1%86%E6%9E%B6/Shiro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Plum Reiver">
      <meta itemprop="description" content="技术，日常，笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李川的个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Shiro框架
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-05-30 00:00:00 / 修改时间：17:13:30" itemprop="dateCreated datePublished" datetime="2021-05-30T00:00:00+08:00">2021-05-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">Java学习</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E5%AD%A6%E4%B9%A0/JavaEE%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">JavaEE框架</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Shiro是一个针对用户权限管理和登录的框架。横跨JSTL标签，控制层和业务层。可以和Spring进行集成。具有缓存功能，会话功能。</p>
<p>Shiro对于用户的权限和认证都是自动的。</p>
<span id="more"></span>

<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>Apache Shiro 是 Java 的一个安全（权限）框架。 </li>
<li>Shiro 可以非常容易的开发出足够好的应用，其不仅可以用在<strong>JavaSE</strong> 环境，也可以用在 <strong>JavaEE</strong> 环境。 </li>
<li>Shiro 可以完成：认证、授权、加密、会话管理、与Web 集成、缓存等。</li>
<li>官网：<a target="_blank" rel="noopener" href="http://shiro.apache.org/%E3%80%82">http://shiro.apache.org/。</a></li>
</ul>
<h2 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h2><ul>
<li><p>基本功能如下图</p>
<p><img src="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207.png"></p>
</li>
<li><p>解释：</p>
<ul>
<li><em>Authentication</em>：<strong>身份认证/登录</strong>，验证用户是不是拥有相应的身份；</li>
<li><em>Authorization</em>：<strong>授权，即权限验证</strong>，验证某个已认证的用户是否拥有某个权限；即判断用 户是否能进行什么操作，如：验证某个用户是否拥有某个角色。或者细粒度的验证某个用户<br>对某个资源是否具有某个权限；</li>
<li><em>Session Manager</em>：会话<strong>管理</strong>，即用户登录后就是一次会话，在没有退出之前，它的所有<br>信息都在会话中；会话可以是普通 JavaSE 环境，也可以是 Web 环境的； </li>
<li><em>Cryptography</em>：<strong>加密，保护数据的安全性</strong>，如密码加密存储到数据库，而不是明文存储；</li>
<li><em>Web Support</em>：<strong>Web 支持</strong>，可以非常容易的集成到Web 环境；</li>
<li><em>Caching</em>：<strong>缓存</strong>，比如用户登录后，其用户信息、拥有的角色/权限不必每次去查，这样可<br>以提高效率；</li>
<li><em>Concurrency</em>：Shiro支持<strong>多线程应用的并发验证</strong>，即如在一个线程中开启另一个线程，能把权限自动传播过去；</li>
<li>Testing：<strong>提供测试支持</strong>；</li>
<li><em>Run As</em>：<strong>允许一个用户假装为另一个用户</strong>（如果他们允许）的身份进行访问；</li>
<li><em>Remember Me</em>：<strong>记住我</strong>，这个是非常常见的功能，即一次登录后，下次再来的话不用登<br>录了。</li>
</ul>
</li>
</ul>
<h2 id="架构-从外部方向"><a href="#架构-从外部方向" class="headerlink" title="架构(从外部方向)"></a>架构(从外部方向)</h2><ul>
<li><p>从外部来看Shiro ，即从应用程序角度的来观察如何使用 Shiro 完成工作：</p>
<p><img src="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-1.png"></p>
</li>
<li><p>解释：</p>
<ul>
<li><em>Subject</em>：<strong>应用代码直接交互的对象是 Subject</strong>，也就是说 Shiro 的对外API 核心就是 Subject。<strong>Subject 代表了当前“用户”</strong>， 这个用户不一定是一个具体的人，与当前应用交互的任何东西都是 Subject，如网络爬虫，机器人等；<strong>与 Subject 的所有交互都会委托给 SecurityManager；****Subject 其实是一个门面，SecurityManager 才是实际的执行者</strong>； </li>
<li><em>SecurityManager</em>：安全管理器；即<strong>所有与安全有关的操作都会与SecurityManager 交互</strong>；且其管理着所有 Subject；可以看出它是 <strong>Shiro的核心</strong>，它<strong>负责与 Shiro 的其他组件进行交互</strong>，它相当于 SpringMVC 中DispatcherServlet 的角色</li>
<li><em>Realm</em>：Shiro <strong>从 Realm 获取安全数据（如用户、角色、权限）</strong>，就是说SecurityManager 要验证用户身份，那么它需要从 Realm 获取相应的用户进行比较以确定用户身份是否合法；也需要从 Realm 得到用户相应的角色/权限进行验证用户是否能进行操作；可以把 Realm 看成 DataSource。</li>
</ul>
</li>
</ul>
<h2 id="架构-从内部方向"><a href="#架构-从内部方向" class="headerlink" title="架构(从内部方向)"></a>架构(从内部方向)</h2><ul>
<li><p>从内部来看Shiro：</p>
<p><img src="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-2.png"></p>
</li>
<li><p>解释：</p>
<ul>
<li><em>Subject</em>：任何可以与应用交互的“用户”；</li>
<li><em>SecurityManager</em> ：相当于SpringMVC 中的 DispatcherServlet；是 Shiro 的心脏；所有具体的交互都通过 SecurityManager 进行控制；它<strong>管理着所有 Subject、且负责进行认证、授权、会话及缓存的管理</strong>。</li>
<li><em>Authenticator</em>：<strong>负责 Subject 认证</strong>，是一个扩展点，可以自定义实现；可以使用认证策略（Authentication Strategy），<strong>即什么情况下算用户认证通过了</strong>；</li>
<li><em>Authorizer</em>：<strong>授权器、即访问控制器</strong>，用来决定主体是否有权限进行相应的操作；<strong>即控制着用户能访问应用中的哪些功能</strong>；</li>
<li><em>Realm</em>：可以有 <strong>1 个或多个 Realm</strong>，可以认为是安全实体数据源，即用于获取安全实体的；可以是JDBC 实现，也可以是内存实现等等；由用户提供；所以一般在应用中都需要实现自己的 Realm； </li>
<li><em>SessionManager</em>：<strong>管理 Session 生命周期的组件</strong>；而 Shiro 并不仅仅可以用在 Web 环境，也可以用在如普通的 JavaSE 环境 </li>
<li><em>CacheManager</em>：<strong>缓存控制器</strong>，来管理如用户、角色、权限等的缓存的；因为这些数据基本上很少改变，放到缓存中后可以提高访问的性能</li>
<li><em>Cryptography</em>：<strong>密码模块</strong>，Shiro 提高了一些常见的加密组件用于如密码加密/解密。</li>
</ul>
</li>
</ul>
<h1 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h1><ul>
<li><p>下载Shiro的项目文件：<a target="_blank" rel="noopener" href="https://mirrors.bfsu.edu.cn/apache/shiro/1.3.2/shiro-root-1.3.2-source-release.zip%E3%80%82">https://mirrors.bfsu.edu.cn/apache/shiro/1.3.2/shiro-root-1.3.2-source-release.zip。</a></p>
<ul>
<li>此项目文件中包含了Shiro的各种配置，以及集成配置。</li>
</ul>
</li>
<li><p>搭建环境：</p>
<ul>
<li><p>第一步：创建Java 项目。</p>
<p><img src="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-3.png"></p>
</li>
<li><p>第二步：导入jar包。</p>
<ul>
<li>jar包地址：<a target="_blank" rel="noopener" href="https://plumriver.lanzoui.com/iGDgwpixbcj">https://plumriver.lanzoui.com/iGDgwpixbcj</a></li>
</ul>
</li>
<li><p>第三步：复制文件到项目中。</p>
<ul>
<li>shiro配置文件shiro.ini</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># =============================================================================</span></span><br><span class="line"><span class="comment"># 快速启动INI领域配置</span></span><br><span class="line"><span class="comment"># =============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># 用户及其分配的角色</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 每一行都符合</span></span><br><span class="line"><span class="comment"># org.apache.shiro.realm.text.TextConfigurationRealm#setUserDefinitions JavaDoc</span></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="comment"># 每个用户都有用户名，密码。以及对应的角色</span></span><br><span class="line"><span class="comment"># 用户“root”，密码为“secret”，角色为“admin”</span></span><br><span class="line"><span class="attr">root</span> = secret, admin</span><br><span class="line"><span class="comment"># 用户“guest”，密码为“guest”，角色为“guest”</span></span><br><span class="line"><span class="attr">guest</span> = guest, guest</span><br><span class="line"><span class="comment"># 密码为“12345”的用户“presidentskroob”，角色为“president”</span></span><br><span class="line"><span class="attr">presidentskroob</span> = <span class="number">12345</span>, president</span><br><span class="line"><span class="comment"># 用户“darkhelmet”，密码为“ludicrousspeed”，角色为“darklord”和“schwartz”</span></span><br><span class="line"><span class="attr">darkhelmet</span> = ludicrousspeed, darklord, schwartz</span><br><span class="line"><span class="comment">#用户“lonestar”，密码为“vespa”，角色为“goodguy”和“schwartz”</span></span><br><span class="line"><span class="attr">lonestarr</span> = vespa, goodguy, schwartz</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># 具有分配权限的角色</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 每一行都符合</span></span><br><span class="line"><span class="comment"># org.apache.shiro.realm.text.TextConfigurationRealm#setRoleDefinitions JavaDoc</span></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="section">[roles]</span></span><br><span class="line"><span class="comment"># “admin”角色具有所有权限，由通配符“*”表示</span></span><br><span class="line"><span class="attr">admin</span> = *</span><br><span class="line"><span class="comment"># “schwartz”角色具有对“lightsaber”的操作的所有权限</span></span><br><span class="line"><span class="attr">schwartz</span> = lightsaber:*</span><br><span class="line"><span class="comment"># 允许“goodguy” 对 “winnebago”类型的 名为“eagle5”的对象，进行“drive”操作</span></span><br><span class="line"><span class="attr">goodguy</span> = winnebago:drive:eagle5</span><br></pre></td></tr></table></figure>

<ul>
<li>日志配置文件log4j.properties</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">log4j.rootLogger</span>=<span class="string">INFO, stdout</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.appender.stdout</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.stdout.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.stdout.layout.ConversionPattern</span>=<span class="string">%d %p [%c] - %m %n</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># General Apache libraries</span></span><br><span class="line"><span class="meta">log4j.logger.org.apache</span>=<span class="string">WARN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Spring</span></span><br><span class="line"><span class="meta">log4j.logger.org.springframework</span>=<span class="string">WARN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default Shiro logging</span></span><br><span class="line"><span class="meta">log4j.logger.org.apache.shiro</span>=<span class="string">TRACE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable verbose logging</span></span><br><span class="line"><span class="meta">log4j.logger.org.apache.shiro.util.ThreadContext</span>=<span class="string">WARN</span></span><br><span class="line"><span class="meta">log4j.logger.org.apache.shiro.cache.ehcache.EhCache</span>=<span class="string">WARN</span></span><br></pre></td></tr></table></figure>

<ul>
<li>快速启动代码Quickstart.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.config.IniSecurityManagerFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.Session;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.Factory;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简单的快速入门应用程序，演示如何使用Shiro的API。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 0.9 RC2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Quickstart</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">transient</span> Logger log = LoggerFactory.getLogger(Quickstart.class);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建具有配置的领域、用户、角色和权限的Shiro SecurityManager的最简单方法是使用简单的INI配置。</span></span><br><span class="line">    <span class="comment">// 我们将使用一个工厂来实现这一点，该工厂可以接收一个.ini文件并返回一个SecurityManager实例：</span></span><br><span class="line">    Factory&lt;SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">&quot;classpath:shiro.ini&quot;</span>);</span><br><span class="line">    SecurityManager securityManager = factory.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于这个简单的示例quickstart，将SecurityManager作为JVM单例进行访问。</span></span><br><span class="line">    <span class="comment">// 大多数应用程序不会这样做，而是依赖其容器配置或web.xml来实现webapps。</span></span><br><span class="line">    <span class="comment">// 这超出了这个简单快速启动的范围，所以我们只做最简单的工作，这样您就可以继续对事物有感觉。</span></span><br><span class="line">    SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 现在设置了一个简单的Shiro环境，让我们看看您可以做什么：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前正在执行的用户Subject：</span></span><br><span class="line">    Subject currentUser = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用会话做一些事情（不需要web或EJB容器！！！）</span></span><br><span class="line">    <span class="comment">//获取Session的方式：Subject的 getSession 方法</span></span><br><span class="line">    Session session = currentUser.getSession();</span><br><span class="line">    <span class="comment">//检测Session是否管用：通过往Session中放数据，然后再获取这个数据。比较放入后数据有没有发生改变。</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;someKey&quot;</span>, <span class="string">&quot;aValue&quot;</span>);</span><br><span class="line">    String value = (String) session.getAttribute(<span class="string">&quot;someKey&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (value.equals(<span class="string">&quot;aValue&quot;</span>)) &#123;</span><br><span class="line">      log.info(<span class="string">&quot;Retrieved the correct value! [&quot;</span> + value + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 让我们登录当前用户，以便检查角色和权限：</span></span><br><span class="line">    <span class="comment">// isAuthenticated()：当已登录时返回true</span></span><br><span class="line">    <span class="keyword">if</span> (!currentUser.isAuthenticated()) &#123;</span><br><span class="line">      <span class="comment">// 将用户名和密码封装成UsernamePasswordToken</span></span><br><span class="line">      UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">&quot;lonestarr&quot;</span>, <span class="string">&quot;vespa&quot;</span>);</span><br><span class="line">      <span class="comment">// RememberMe：记住我。设置为true</span></span><br><span class="line">      token.setRememberMe(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//执行登录</span></span><br><span class="line">        currentUser.login(token);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (UnknownAccountException uae) &#123; <span class="comment">// 此异常表示为：没有当前用户</span></span><br><span class="line">        log.info(<span class="string">&quot;There is no user with username of &quot;</span> + token.getPrincipal());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncorrectCredentialsException ice) &#123; <span class="comment">// 此异常表示为：密码不正确</span></span><br><span class="line">        log.info(<span class="string">&quot;Password for account &quot;</span> + token.getPrincipal() + <span class="string">&quot; was incorrect!&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (LockedAccountException lae) &#123; <span class="comment">// 此异常表示为：用户被锁定</span></span><br><span class="line">        log.info(<span class="string">&quot;The account for username &quot;</span> + token.getPrincipal() + <span class="string">&quot; is locked.  &quot;</span> +</span><br><span class="line">                 <span class="string">&quot;Please contact your administrator to unlock it.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ... 在这里捕获更多异常（可能是特定于您的应用程序的自定义异常？)</span></span><br><span class="line">      <span class="keyword">catch</span> (AuthenticationException ae) &#123; <span class="comment">// 此异常表示为：验证失败异常。此异常是所有认证异常的父类。</span></span><br><span class="line">        <span class="comment">//unexpected condition?  error?</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// say who they are:</span></span><br><span class="line">    <span class="comment">//print their identifying principal (in this case, a username):</span></span><br><span class="line">    log.info(<span class="string">&quot;User [&quot;</span> + currentUser.getPrincipal() + <span class="string">&quot;] logged in successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 测试当前用户是否有此角色。</span></span><br><span class="line">    <span class="keyword">if</span> (currentUser.hasRole(<span class="string">&quot;schwartz&quot;</span>)) &#123;</span><br><span class="line">      log.info(<span class="string">&quot;May the Schwartz be with you!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      log.info(<span class="string">&quot;Hello, mere mortal.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 测试当前用户是否有某一个权限（非实例级）</span></span><br><span class="line">    <span class="keyword">if</span> (currentUser.isPermitted(<span class="string">&quot;lightsaber:weild&quot;</span>)) &#123;</span><br><span class="line">      log.info(<span class="string">&quot;You may use a lightsaber ring.  Use it wisely.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      log.info(<span class="string">&quot;Sorry, lightsaber rings are for schwartz masters only.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// a (very powerful) Instance Level permission:</span></span><br><span class="line">    <span class="comment">//测试当前用户是否具有 “winnebago:drive:eagle5“ 的权限</span></span><br><span class="line">    <span class="keyword">if</span> (currentUser.isPermitted(<span class="string">&quot;winnebago:drive:eagle5&quot;</span>)) &#123;</span><br><span class="line">      log.info(<span class="string">&quot;You are permitted to &#x27;drive&#x27; the winnebago with license plate (id) &#x27;eagle5&#x27;.  &quot;</span> +</span><br><span class="line">               <span class="string">&quot;Here are the keys - have fun!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      log.info(<span class="string">&quot;Sorry, you aren&#x27;t allowed to drive the &#x27;eagle5&#x27; winnebago!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//全部完成-退出/注销/登出！</span></span><br><span class="line">    currentUser.logout();</span><br><span class="line"></span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>第四步：启动即可。</p>
</li>
</ul>
</li>
<li><p>对HelloWorld的执行过程的思考：</p>
<ul>
<li>当请求发送到后端时，先获取当前后端线程的</li>
</ul>
</li>
</ul>
<h1 id="集成Spring"><a href="#集成Spring" class="headerlink" title="集成Spring"></a>集成Spring</h1><ul>
<li><p>搭建框架：</p>
<ul>
<li>第一步：创建Javaweb项目。</li>
</ul>
<p><img src="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-4.png"></p>
<ul>
<li><p>第二步：导入Spring,SpringMVC的jar包。</p>
</li>
<li><p>第三步：配置Spring,和SpringMVC的配置。</p>
<ul>
<li>web.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--引入Spring配置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:applicationContext.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--引入SpringMVC配置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMVC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc-config.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springMVC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>spring的applicationContext.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.lc&quot;</span> <span class="attr">use-default-filters</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.web.bind.annotation.ControllerAdvice&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>springmvc的springmvc-config.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.lc&quot;</span> <span class="attr">use-default-filters</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.web.bind.annotation.ControllerAdvice&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/views/&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--mvc的两个基本配置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>&gt;</span><span class="tag">&lt;/<span class="name">mvc:default-servlet-handler</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>第四步：启动项目。如果项目跑起来了，表示搭建没有出错。</p>
</li>
<li><p>第五步：导入Shiro的jar包。</p>
</li>
<li><p>第六步：参照件shiro-root-1.3.2\samples\spring\src\main\webapp\WEB-INF下的配置文件对项目进行整改。</p>
<ul>
<li>web.xml的修改</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Shiro过滤器在spring应用程序上下文中定义： --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetFilterLifecycle<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>applicationContext.xml的修改</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- =========================================================</span></span><br><span class="line"><span class="comment">       Shiro核心组件 - Not Spring Specific</span></span><br><span class="line"><span class="comment">       ========================================================= --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置securityManager，安全管理器（当没有web环境时，使用DefaultSecurityManager）--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;securityManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.web.mgt.DefaultWebSecurityManager&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cacheManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;cacheManager&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 单一领域应用程序。如果您有多个领域，请改用&#x27;realms&#x27;属性。 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;native&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;realm&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;jdbcRealm&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--让我们使用一些企业缓存支持来获得更好的性能。您可以用您喜欢的任何企业缓存框架实现（Terracotta+Ehcache、Coherence、GigaSpaces等）来代替它 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--配置cacheManager，缓存管理器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;cacheManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.cache.ehcache.EhCacheManager&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 如果已经有net.sf.ehcache.CacheManager实例，请在此处设置。否则，将使用默认配置创建新配置：</span></span><br><span class="line"><span class="comment">         &lt;property name=&quot;cacheManager&quot; ref=&quot;ehCacheManager&quot;/&gt; --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 如果没有要注入的预构建net.sf.ehcache.CacheManager实例，但希望使用特定的ehcache配置，请在此处指定。否则，将使用默认值：--&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cacheManagerConfigFile&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:ehcache.xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 由SecurityManager用于访问安全数据（用户、角色等）。也可以使用许多其他领域实现（PropertiesRealm、LdapRealm等）。 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;bean id=&quot;jdbcRealm&quot; class=&quot;org.apache.shiro.samples.spring.realm.SaltAwareJdbcRealm&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;property name=&quot;name&quot; value=&quot;jdbcRealm&quot;/&gt;</span></span><br><span class="line"><span class="comment">    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;</span></span><br><span class="line"><span class="comment">    &lt;property name=&quot;credentialsMatcher&quot;&gt;</span></span><br><span class="line"><span class="comment">      &amp;lt;!&amp;ndash; &#x27;bootstrapDataPopulator&#x27;Sha256散列密码（使用用户名作为salt），然后base64对其进行编码：&amp;ndash;&amp;gt;</span></span><br><span class="line"><span class="comment">      &lt;bean class=&quot;org.apache.shiro.authc.credential.HashedCredentialsMatcher&quot;&gt;</span></span><br><span class="line"><span class="comment">        &lt;property name=&quot;hashAlgorithmName&quot; value=&quot;SHA-256&quot;/&gt;</span></span><br><span class="line"><span class="comment">        &amp;lt;!&amp;ndash; true表示十六进制编码，false表示base64编码&amp;ndash;&amp;gt;</span></span><br><span class="line"><span class="comment">        &lt;property name=&quot;storedCredentialsHexEncoded&quot; value=&quot;false&quot;/&gt;</span></span><br><span class="line"><span class="comment">      &lt;/bean&gt;</span></span><br><span class="line"><span class="comment">    &lt;/property&gt;</span></span><br><span class="line"><span class="comment">  &lt;/bean&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--自定义配置Realm。</span></span><br><span class="line"><span class="comment">        1.指定自定义的Realm的实现类</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcRealm&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.lc.bean.realm.ShiroRealm&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- =========================================================</span></span><br><span class="line"><span class="comment">       Shiro-Spring特定集成</span></span><br><span class="line"><span class="comment">       ========================================================= --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 为Spring配置的Shiro对象自动调用init（）和destroy（）方法的ost处理器，</span></span><br><span class="line"><span class="comment">        这样您就不必</span></span><br><span class="line"><span class="comment">            1) 为每个bean定义指定init方法和destroy方法属性</span></span><br><span class="line"><span class="comment">            2) 甚至知道哪些Shiro对象需要调用这些方法。 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--配置。可以自动的来调用配置在IOC中ShiroBean的生命周期方法--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;lifecycleBeanPostProcessor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.spring.LifecycleBeanPostProcessor&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 为Spring配置的bean启用Shiro注释。仅在lifecycleBeanProcessor运行后运行： --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">depends-on</span>=<span class="string">&quot;lifecycleBeanPostProcessor&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;securityManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;securityManager&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 安全springremoting：确保任何springremoting方法调用都可以与一个主题相关联以进行安全检查。远程调用的使用 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;bean id=&quot;secureRemoteInvocationExecutor&quot; class=&quot;org.apache.shiro.spring.remoting.SecureRemoteInvocationExecutor&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;property name=&quot;securityManager&quot; ref=&quot;securityManager&quot;/&gt;</span></span><br><span class="line"><span class="comment">  &lt;/bean&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 在这里定义Shiro过滤器shiroFilter（作为FactoryBean），</span></span><br><span class="line"><span class="comment">  而不是直接在web.xml中定义 —— web.xml中使用DelegatingFilterProxy来访问这个bean。</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--注意事项：</span></span><br><span class="line"><span class="comment">    1.此处的id必须和web.xml中对应的filter-name一致。</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;shiroFilter&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.spring.web.ShiroFilterFactoryBean&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;securityManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;securityManager&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--登陆页面--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;loginUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/login.jsp&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--登陆成功的页面--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;successUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/success.jsp&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--登陆后没有权限的页面--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;unauthorizedUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/unauthorized.jsp&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- “filters”属性不是必需的，因为定义的任何声明的javax.servlet.Filter bean都将通过其链定义中的beanName自动获取并可用，</span></span><br><span class="line"><span class="comment">    但如果您愿意，可以在此处执行重写或parentchild合并配置：--&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;property name=&quot;filters&quot;&gt;</span></span><br><span class="line"><span class="comment">        &lt;util:map&gt;</span></span><br><span class="line"><span class="comment">            &lt;entry key=&quot;aName&quot; value-ref=&quot;someFilterPojo&quot;/&gt;</span></span><br><span class="line"><span class="comment">        &lt;/util:map&gt;</span></span><br><span class="line"><span class="comment">    &lt;/property&gt; --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--配置哪些页面需要受保护，以及访问这些页面需要的权限。</span></span><br><span class="line"><span class="comment">      anon ：意为此资源可以被匿名访问。</span></span><br><span class="line"><span class="comment">      authc ：表示必须认证之后才能访问。</span></span><br><span class="line"><span class="comment">      /** ：表示对所有资源。</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filterChainDefinitions&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">      /favicon.ico = anon</span><br><span class="line">      /logo.png = anon</span><br><span class="line">      /shiro.css = anon</span><br><span class="line">      /login.jsp = anon</span><br><span class="line">      /** = authc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>第七步：新建login.jsp。list.jsp。unauthorized.jsp。</p>
</li>
</ul>
</li>
<li><p>与Web 集成：</p>
<ul>
<li>Shiro 提供了与 Web 集成的支持，其通过一个<strong>ShiroFilter</strong> 入口来拦截需要安全控制的URL，然后进行相应的控制。</li>
<li>ShiroFilter 类似于如 Strut2/SpringMVC 这种web 框架的前端控制器，是安全控制的入口点，其负责读取配置（如ini 配置文件），然后判断URL是否需要登录/权限等工作。</li>
</ul>
</li>
</ul>
<h1 id="ShiroFilter"><a href="#ShiroFilter" class="headerlink" title="ShiroFilter"></a>ShiroFilter</h1><ul>
<li><p>工作原理：</p>
<p><img src="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-5.png"></p>
</li>
<li><p>web.xml配置文件中的DelegatingFilterProxy：</p>
<ul>
<li>作用是自动到 Spring 容器查找名字为 shiroFilter（filter-name）的 bean 并把<strong>所有 Filter 的操作委托给它</strong>。</li>
<li>如果找不到会抛出<strong>NoSuchBeanDefinitionException异常</strong>。</li>
<li>原理：DelegatingFilterProxy是Filter的代理对象，默认情况下Spring回到IOC中查找和&lt;filter-name&gt;相同的filterBean。</li>
<li>也可以通过配置初始化参数<strong>targetBeanName</strong>来配置filterBean的id名字。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetBeanName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>abc<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在applicationContext.xml的 filterChainDefinitions 属性的配置原理：</p>
<ul>
<li>[urls] 部分的配置，其格式是： “**url=拦截器[参数]**”。</li>
<li>拦截器也叫过滤器。</li>
<li>如果当前请求的 url 匹配 [urls] 部分的某个 url 模式，将会执行其配置的拦截器。 </li>
<li>anon（anonymous） 拦截器表示匿名访问（即不需要登录即可访问） 。</li>
<li>authc （authentication）拦截器表示需要身份认证通过后才能访问。</li>
</ul>
</li>
<li><p>shiro中默认的过滤器：</p>
<p><img src="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210528180207-6.png"></p>
</li>
<li><p>URL 匹配模式：</p>
<ul>
<li><strong>url 模式使用 Ant 风格模式</strong></li>
<li>Ant 路径通配符支持 ?、*、**，注意通配符匹配不包括目录分隔符“/”：<ul>
<li>– ?：匹配一个字符，如 /admin? 将匹配 /admin1，但不匹配 /admin 或 /admin/；</li>
<li>*：匹配零个或多个字符串，如 /admin 将匹配 /admin、/admin123，但不匹配 /admin/1； </li>
<li>*<em>：匹配路径中的零个或多个路径，如 /admin/</em>* 将匹配 /admin/a 或 /admin/a/b</li>
</ul>
</li>
</ul>
</li>
<li><p>URL 匹配顺序：</p>
<ul>
<li><strong>URL 权限采取第一次匹配优先的方式</strong>，即从头开始使用第一个匹配的 url 模式对应的拦截器链。</li>
<li>如：</li>
<li>— /bb/**=filter1</li>
<li>— /bb/aa=filter2</li>
<li>— /**=filter3</li>
<li> — 如果请求的url是“/bb/aa”，因为按照声明顺序进行匹配，那么将使用 filter1 进行拦截。</li>
</ul>
</li>
</ul>
<h1 id="认证功能"><a href="#认证功能" class="headerlink" title="认证功能"></a>认证功能</h1><h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><ul>
<li><p>身份验证：一般需要提供如身份 ID 等一些标识信息来表明登录者的身份，如提供 email，用户名/密码来证明。</p>
</li>
<li><p>在 shiro 中，用户需要提供 <strong>principals （身份）和 credentials（证明）</strong>给 shiro，从而应用能验证用户身份：</p>
<ul>
<li><strong>principals</strong>：身份，即<strong>主体的标识属性</strong>，可以是任何属性，如用户名、邮箱等，<strong>唯一即可</strong>。一个主体可以有多个 principals，但只有一个Primary principals，一般是用户名/邮箱/手机号。</li>
<li><strong>credentials</strong>：<strong>证明/凭证</strong>，即只有主体知道的安全值，如<strong>密码/数字证书</strong>等。</li>
</ul>
</li>
<li><p>最常见的 principals 和 credentials 组合就是用户名/密码了</p>
</li>
<li><p>身份验证的基本流程：</p>
<ul>
<li>第一步：获取当前Subject。调用SecurityUtils.getSubject()方法。</li>
<li>第二步：测试当前的用户是否被认证，即是否已经登录。调用Subject的isAuthenticated方法。</li>
<li>第三步：如果没有认证。则将身份和证明封装成UsernamePasswordToken对象。<ul>
<li>上面三步一般在Handler中实现。通过通过请求获取到用户信息。</li>
</ul>
</li>
<li>第四步：对未认证的用户执行登录。调用Subject的login()方法。</li>
</ul>
</li>
<li><p>login()方法的实现流程：</p>
<ul>
<li>在Subject的login()方法中调用SecurityManager的login()方法。</li>
<li>在SecurityManager的login()方法中调用Authenticator的authenticate()方法。</li>
<li>在Authenticator的authenticate()方法通过一层层子类的实现，最终调用Realm的getAuthenticationInfo()方法。</li>
<li>Realm的getAuthenticationInfo()方法通过查询数据库，最终将结果一层层返回到Shiro中。</li>
<li>最后由shiro完成用户信息的比对。</li>
</ul>
</li>
<li><p>实现登录，登出功能。</p>
<ul>
<li>第一步：网页。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">&quot;shiroLogin&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">  username:&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;user&quot;</span>&gt;&lt;br&gt;</span><br><span class="line">  password:&lt;input type=<span class="string">&quot;password&quot;</span> name=<span class="string">&quot;pas&quot;</span>&gt;&lt;br&gt;</span><br><span class="line">  &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;a href=&quot;/shiroLogout&quot;&gt;登出&lt;/a&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第二步：handler层代码。</p>
<ul>
<li>登出功能不需要写对应的处理方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;shiroLogin&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(<span class="meta">@RequestParam(&quot;user&quot;)</span>String user,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="meta">@RequestParam(&quot;pas&quot;)</span>String password)</span></span>&#123;</span><br><span class="line">  Subject currentSubject = SecurityUtils.getSubject();</span><br><span class="line">  System.out.println(<span class="string">&quot;currentSubject: &quot;</span>+currentSubject.hashCode());</span><br><span class="line">  <span class="comment">//当登陆成功后，从此连接再次登录时，认证将会通过，不在查询数据库。</span></span><br><span class="line">  <span class="keyword">if</span> (!currentSubject.isAuthenticated()) &#123;</span><br><span class="line">    <span class="comment">// 将用户名和密码封装成UsernamePasswordToken</span></span><br><span class="line">    UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(user, password);</span><br><span class="line">    <span class="comment">// RememberMe：记住我。设置为true</span></span><br><span class="line">    <span class="comment">//token.setRememberMe(true);</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//执行登录</span></span><br><span class="line">      System.out.println(token.hashCode());</span><br><span class="line">      currentSubject.login(token);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AuthenticationException ae) &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;exception: &quot;</span> + ae.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;redirect:/list.jsp&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>第三步：自定义实现Realm的子类。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroRealm</span> <span class="keyword">extends</span> <span class="title">AuthenticatingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;访问数据库，查询数据: &quot;</span> + authenticationToken.hashCode());</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过查看AuthenticationToken的继承关系可知，AuthenticationToken是Handler中UsernamePasswordToken的父类。</span></span><br><span class="line"><span class="comment">     * 又因为在handler中打印的UsernamePasswordToken的hashCode和此处AuthenticationToken的hashCode相同。</span></span><br><span class="line"><span class="comment">     * 因此可以得到此处的AuthenticationToken是Handler中UsernamePasswordToken对象的引用。</span></span><br><span class="line"><span class="comment">     * 就像List和ArrayList的关系</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//第一步：把AuthenticationToken强转成UsernamePasswordToken</span></span><br><span class="line">    UsernamePasswordToken token = (UsernamePasswordToken) authenticationToken;</span><br><span class="line">    <span class="comment">//第二步：从UsernamePasswordToken中获取username信息</span></span><br><span class="line">    String username = token.getUsername();</span><br><span class="line">    <span class="comment">//第三步：调用数据库的方法，从数据库中查询username的信息</span></span><br><span class="line">    <span class="comment">//User user = UserService.getUserByUserName();</span></span><br><span class="line">    <span class="comment">//这里用静态资源处理测试</span></span><br><span class="line">    Map&lt;String,String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    result.put(username,<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第四步：若用户不存在，则抛出UnknownAccountException异常</span></span><br><span class="line">    <span class="keyword">if</span> (result.get(username) == <span class="keyword">null</span>)&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//第五步：根据用户信息的情况，决定抛出其他异常</span></span><br><span class="line">    String password = <span class="keyword">new</span> String(token.getPassword());</span><br><span class="line">    <span class="keyword">if</span> (!password.equals(result.get(username)))&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectCredentialsException(<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第六步：用户存在，且不抛出异常。则构建AuthenticationInfo对象并返回</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SimpleAuthenticationInfo的三个参数说明：</span></span><br><span class="line"><span class="comment">     * Object principal ：认证的实体信息，可以是username，也可以是数据库查询的结果</span></span><br><span class="line"><span class="comment">     * Object credentials ：对应的凭据，比如密码。这个密码是从数据库中查询到的密码。</span></span><br><span class="line"><span class="comment">     * String realmName ：当前realm的name。调用当前父类的getName()方法即可。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object principal = username;</span><br><span class="line">    Object credentials = result.get(username);</span><br><span class="line">    String realmName = <span class="keyword">this</span>.getName();</span><br><span class="line">    SimpleAuthenticationInfo info = <span class="keyword">new</span> SimpleAuthenticationInfo(principal,credentials,realmName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第四步：对Spring配置文件中Shiro的拦截规则的修改。</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filterChainDefinitions&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">    /login.jsp = anon</span><br><span class="line">    /shiroLogin = anon</span><br><span class="line">    /shiroLogout = logout</span><br><span class="line"></span><br><span class="line">    /** = authc</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>注意事项：<ul>
<li>hadler中的token和Realm中的token是同一个对象。</li>
<li>Realm中返回值的credentials的值要从数据库中获取。</li>
<li>要注意修改Shiro的拦截规则，防止登录请求被拦截了。</li>
</ul>
</li>
</ul>
<h2 id="密码的比对"><a href="#密码的比对" class="headerlink" title="密码的比对"></a>密码的比对</h2><ul>
<li><p>首先：对于密码的比对不是在Realm中查询数据库后进行比对的。</p>
<ul>
<li>因为在Realm中有两处存放密码的地方。doGetAuthenticationInfo()方法的参数存放了一对用户和密码信息，它的返回值也存放了一对用户和密码信息。</li>
</ul>
</li>
<li><p>真正的密码比对发生在AuthenticatingRealm类中，通过调用CredentialsMatcher对象的doCredentialsMatch()方法进行比对。</p>
</li>
<li><p>在实际情况中，从数据库查出的信息中密码是加密后的。</p>
<ul>
<li>而密码的比对需要一个规则。因此Shiro需要指定加密的方式。</li>
</ul>
</li>
<li><p><strong>实现加密的操作</strong>：以MD5加密为例。</p>
<ul>
<li>第一步：替换当前Realm的CredentialsMatcher属性。</li>
<li>第二步：使用HashedCredentialsMatcher对象，并设置加密算法.</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcRealm&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.lc.bean.realm.ShiroRealm&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--设置加密方式--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;credentialsMatcher&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.authc.credential.HashedCredentialsMatcher&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--HashedCredentialsMatcher的子实现类有6个，因此可以设置6种。具体设置值可以查看源码--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hashAlgorithmName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MD5&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>加密过程说明：</p>
<ul>
<li>在通过Realm获取到数据库数据后，Shiro将会对token和info中的密码进行比对。</li>
<li>再比对先，会通过加密的方式将token中的数据进行加密。</li>
<li>然后将加密后的数据与info中的数据（也就是数据库中的密码）按照字节一一比对。</li>
<li>加密的具体方式是使用SimpleHash类。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//说明：hashIterations：意为加密的次数，可以通过设置HashedCredentialsMatcher的hashIterations属性来设置。</span></span><br><span class="line"><span class="comment">//salt：表示盐值。用于解决密码相同，加密后数据也相同的问题。</span></span><br><span class="line"><span class="keyword">new</span> SimpleHash(hashAlgorithmName, credentials, salt, hashIterations)</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--指定加密的次数--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hashIterations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>另一个问题：如果两个人的密码一样，则加密后的数据是一样的。这是不安全的。</p>
<ul>
<li>因此：如何实现即使密码一样，加密后的数据也不一样呢？</li>
</ul>
</li>
<li><p><strong>升级后的加密操作</strong>：</p>
<ul>
<li><p>在Relam中，返回值的创建过程中传入盐值credentialsSalt。</p>
</li>
<li><p>然后再密码的比过程时，对密码进行加密时就会带上这个盐值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//盐值：一般设置为唯一值。这里username本身就是唯一的，因此将盐值设置为username</span></span><br><span class="line">ByteSource credentialsSalt = ByteSource.Util.bytes(username);</span><br><span class="line">SimpleAuthenticationInfo info = <span class="keyword">new</span> SimpleAuthenticationInfo(principal,credentials,credentialsSalt,realmName);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>总结：在密码比对时，要设置加密策略来保证安全。同时要添加盐值以保证更安全。</p>
</li>
</ul>
<h2 id="多Realm时的验证"><a href="#多Realm时的验证" class="headerlink" title="多Realm时的验证"></a>多Realm时的验证</h2><ul>
<li><p>单Realm和多Realm的区别：</p>
<ul>
<li>在login()登录时。有如下代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doAuthenticate</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.assertRealmsConfigured();</span><br><span class="line">  Collection&lt;Realm&gt; realms = <span class="keyword">this</span>.getRealms();</span><br><span class="line">  <span class="keyword">if</span>(realms.size() == <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="comment">//当Realm为1时，走这个方法。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.doSingleRealmAuthentication((Realm)realms.iterator().next(), authenticationToken);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//当Realm为多个时，走这个方法。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.doMultiRealmAuthentication(realms, authenticationToken);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>模拟两个Realm的情况：</p>
<ul>
<li>第一步：创建两个Realm。配置加密分别为MD5,和SHA1。</li>
<li>第二步：修改applicationContext.xml文件。<ul>
<li>需要修改securityManager。并添加一个Realm配置，</li>
<li>添加duoRealm的匹配器ModularRealmAuthenticator。</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;securityManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.web.mgt.DefaultWebSecurityManager&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cacheManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;cacheManager&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;authenticator&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;authenticator&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!--配置多Realm情况下需要添加的验证器Bean--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;authenticator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.authc.pam.ModularRealmAuthenticator&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;realms&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;shiroRealm&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;secondRealm&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;secondRealm&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.lc.bean.realm.SecondRealm&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--设置加密方式--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;credentialsMatcher&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.authc.credential.HashedCredentialsMatcher&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hashAlgorithmName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SHA1&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hashIterations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>多Realm时，对于用户的验证是按照配置中list标签的顺序进行的。</p>
<ul>
<li>多Realm时，每个Realm都会对信息进行验证吗？验证策略时什么？</li>
</ul>
</li>
<li><p>多Realm的验证策略由AuthenticationStrategy指定。</p>
</li>
<li><p>AuthenticationStrategy 接口的默认实现： </p>
<ul>
<li><strong>FirstSuccessfulStrategy</strong>：<strong>只要有一个 Realm 验证成功即可</strong>，只返回第一个 Realm 身份验证成功的认证信息，其他的忽略；</li>
<li><strong>AtLeastOneSuccessfulStrategy</strong>：只要有一个Realm验证成功即可，和FirstSuccessfulStrategy 不同，将<strong>返回所有Realm身份验证成功的认证信息</strong>；</li>
<li><strong>AllSuccessfulStrategy</strong>：<strong>所有Realm验证成功才算成功</strong>，且返回所有Realm身份验证成功的认证信息，如果有一个失败就失败了。</li>
</ul>
</li>
<li><p>ModularRealmAuthenticator 默认是 AtLeastOneSuccessfulStrategy策略。</p>
</li>
<li><p>细节问题：</p>
<ul>
<li>在配置securityManager时会发现其属性中由Realms。而在authenticator中也会发现Realms属性。</li>
<li>这两个有什么区别吗？如果两个Realms一样的效果，应该配在哪里？</li>
<li>经实验发现。在调用Realm的时候是通过authenticator对象调用的。</li>
<li>但是当在securityManager中配置Realms，而在authenticator中不配置Realms时，也是通过authenticator对象调用Realm，且不报错。这是问什么呢？</li>
<li>这是因为在securityManager中配置Realms时，初始化的时候，会将自己的Realms传递给authenticator。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如下述代码。</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterRealmsSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>.afterRealmsSet();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.authenticator <span class="keyword">instanceof</span> ModularRealmAuthenticator) &#123;</span><br><span class="line">    ((ModularRealmAuthenticator)<span class="keyword">this</span>.authenticator).setRealms(<span class="keyword">this</span>.getRealms());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结论：Realms一般配置在securityManager中即可。不需要在authenticator中配置。</li>
</ul>
</li>
</ul>
<h1 id="授权功能"><a href="#授权功能" class="headerlink" title="授权功能"></a>授权功能</h1><ul>
<li><p>授权，也叫<strong>访问控制，即在应用中控制谁访问哪些资源</strong>（如访问页面/编辑数据/页面操作 等）。在授权中需了解的几个关键对象：主体（Subject）、资源（Resource）、权限（Permission）、角色（Role）。</p>
</li>
<li><p>主体(Subject)：访问应用的用户，在 Shiro 中<strong>使用 Subject 代表该用户</strong>。用户只有授权后才允许访问相应的资源。</p>
</li>
<li><p>资源(Resource)：<strong>在应用中用户可以访问的 URL</strong>，比如访问 JSP 页面、查看/编辑某些数据、访问某个业务方法、打印文本等等都是资源。用户只要授权后才能访问。</p>
</li>
<li><p>权限(Permission)：<strong>安全策略中的原子授权单位</strong>，通过权限我们可以表示在应用中用户有没有操作某个资源的权力。即权限表示在应用中用户能不能访问某个资源，如：访问用户列表页面查看/新增/修改/删除用户数据（即很多时候都是CRUD（增查改删）式权限控制）等。权限代表了用户有没有操作某个资源的权利，即反映在某个资源上的操作允不允许。</p>
</li>
<li><p>Shiro 支持<strong>粗粒度权限（如用户模块的所有权限）和细粒度权限（操作某个用户的权限</strong>，即实例级别的）。</p>
</li>
<li><p> 角色(Role)：<strong>权限的集合</strong>，一般情况下会赋予用户角色而不是权限，即这样用户可以拥有一组权限，赋予权限时比较方便。典型的如：项目经理、技术总监、CTO、开发工程师等都是角色，不同的角色拥有一组不同的权限。</p>
</li>
<li><p>授权方式：</p>
<ul>
<li>编程式：通过写if/else 授权代码块完成 。</li>
<li>注解式：通过在执行的Java方法上放置相应的注解完成，没有权限将抛出相应的异常 。常用。</li>
<li>JSP/GSP 标签：在JSP/GSP 页面通过相应的标签完成。</li>
</ul>
</li>
<li><p>默认的拦截器：</p>
<ul>
<li>Shiro 内置了很多默认的拦截器，比如身份验证、授权等相关的。</li>
<li>默认拦截器可以参考org.apache.shiro.web.filter.mgt.DefaultFilter中的枚举拦截器：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">DefaultFilter</span> </span>&#123;</span><br><span class="line">  anon(AnonymousFilter.class),</span><br><span class="line">  authc(FormAuthenticationFilter.class),</span><br><span class="line">  authcBasic(BasicHttpAuthenticationFilter.class),</span><br><span class="line">  logout(LogoutFilter.class),</span><br><span class="line">  noSessionCreation(NoSessionCreationFilter.class),</span><br><span class="line">  perms(PermissionsAuthorizationFilter.class),</span><br><span class="line">  port(PortFilter.class),</span><br><span class="line">  rest(HttpMethodPermissionFilter.class),</span><br><span class="line">  roles(RolesAuthorizationFilter.class),</span><br><span class="line">  ssl(SslFilter.class),</span><br><span class="line">  user(UserFilter.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拦截器的使用：</li>
</ul>
<p><img src="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210530171033.png"></p>
</li>
<li><p>权限(Permission)的说明：</p>
<ul>
<li>规则：<strong>资源标识符：操作：对象实例 ID</strong> 。</li>
<li>即对哪个资源的哪个实例可以进行什么操作。其<strong>默认支持通配符权限字符串</strong>。</li>
<li>“: “表示资源/操作/实例的分割；</li>
<li>“,” 表示操作的分割，</li>
<li>“* 表示任意资源/操作/实例。</li>
<li><strong>多层次管理</strong><ul>
<li>例如：user:query、user:edit。<ul>
<li>表示授予user角色query和edit的权限。</li>
</ul>
</li>
<li><strong>冒号是一个特殊字符，它用来分隔权限字符串的下一部件</strong>：<ul>
<li>第一部分是权限被操作的领域（打印机），</li>
<li>第二部分是被执行的操作。</li>
</ul>
</li>
<li>多个值：<strong>每个部件能够保护多个值</strong>。因此，除了授予用户 user:query和 user:edit 权限外，也可以简单地授予他们一个：user:query, edit</li>
<li>还可以<strong>用 * 号代替所有的值</strong>，如：user:* ， 也可以写：*:query，表示某个用户在所有的领域都有 query 的权限。</li>
</ul>
</li>
<li><strong>实例级访问控制</strong><ul>
<li>这种情况通常会使用三个部件：<strong>域、操作、被付诸实施的实例</strong>。如：user:edit:manager<ul>
<li>表示授予user角色对manager对象的edit权限。</li>
</ul>
</li>
<li>也可以<strong>使用通配符</strong>来定义，如：user:edit:*、user:*:*、user:*:manager</li>
<li><strong>部分省略通配符</strong>：缺少的部件意味着用户可以访问所有与之匹配的值，比如：user:edit 等价于 user:edit :*、user 等价于 user:*:*。</li>
<li>注意：<strong>通配符只能从字符串的结尾处省略部件</strong>，也就是说 user:edit 并不等价于 user:*:edit</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="授权功能-1"><a href="#授权功能-1" class="headerlink" title="授权功能"></a>授权功能</h2><ul>
<li><p>授权功能的流程：</p>
<ul>
<li><p>第一步：调用Subject的isPermitted*/hasRole*()方法。</p>
</li>
<li><p>第二步：调用securityManager的hasRole()方法。实际上调用的是securityManager的父类Authorizer的hasRole()方法。</p>
</li>
<li><p>第三步：调用Authorizer的子类的hasRole()方法。</p>
<ul>
<li>此时当Realm为1个时调用的是AuthorizingRealm的hasRole()方法。获取当前subject的权限信息。然后进行验证。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRole</span><span class="params">(PrincipalCollection principal, String roleIdentifier)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//获取权限信息</span></span><br><span class="line">  AuthorizationInfo info = <span class="keyword">this</span>.getAuthorizationInfo(principal);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.hasRole(roleIdentifier, info);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//对权限信息进行验证</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">hasRole</span><span class="params">(String roleIdentifier, AuthorizationInfo info)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> info != <span class="keyword">null</span> &amp;&amp; info.getRoles() != <span class="keyword">null</span> &amp;&amp; info.getRoles().contains(roleIdentifier);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当Realm为多个时，调用ModularRealmAuthorizer的hasRole()方法。遍历当前的Realm，然后调用此Realm时的AuthorizingRealm。剩下的就和Realm为1个的情况相同。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRole</span><span class="params">(PrincipalCollection principals, String roleIdentifier)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//检测当前ModularRealmAuthorizer的Realms属性是否有值</span></span><br><span class="line">  <span class="keyword">this</span>.assertRealmsConfigured();</span><br><span class="line">  Iterator var3 = <span class="keyword">this</span>.getRealms().iterator();</span><br><span class="line"></span><br><span class="line">  Realm realm;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">//当一个Realm验证不通过时，就全都验证不通过。</span></span><br><span class="line">    <span class="keyword">if</span> (!var3.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    realm = (Realm)var3.next();</span><br><span class="line">    <span class="comment">//依次调用AuthorizingRealm的hasRole方法。</span></span><br><span class="line">  &#125; <span class="keyword">while</span>(!(realm <span class="keyword">instanceof</span> Authorizer) || !((Authorizer)realm).hasRole(principals, roleIdentifier));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>授权功能的实现：</p>
<ul>
<li>由授权流程可知：检验授权前会先获取授权信息。因此Realm需要继承AuthorizingRealm类。并实现其doGetAuthorizationInfo方法。因为这个方式会在授权时被调用。</li>
<li>AuthorizingRealm类继承自AuthenticatingRealm，但没有实现AuthenticatingRealm中的doGetAuthenticationInfo方法。所以认证和授权只需要继承AuthorizingRealm类就可以了。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">  <span class="comment">//获取用户角色信息</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//获取用户信息</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>实例：</p>
<ul>
<li>第一步：创建两个页面admin.jsp和user.jsp。</li>
<li>第二步：更改配置文件中的拦截规则。设置为对应角色才能访问。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filterChainDefinitions&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">    /login.jsp = anon</span><br><span class="line">    /shiroLogin = anon</span><br><span class="line">    /shiroLogout = logout</span><br><span class="line">    /user.jsp = roles[user]</span><br><span class="line">    /admin.jsp = roles[admin]</span><br><span class="line"></span><br><span class="line">    /** = authc</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第三步：选择一个Realm，实现doGetAuthorizationInfo方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//授权功能的实现：获取用户的角色信息</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1.利用principalCollection获取登录用户信息</span></span><br><span class="line">  Object principal = principalCollection.getPrimaryPrincipal();</span><br><span class="line">  <span class="comment">// 2.利用用户信息来获取用户的角色信息。</span></span><br><span class="line">  <span class="comment">// 如果principalCollection中没有角色信息，可能还需要去数据库中查找</span></span><br><span class="line">  Set&lt;String&gt; roles = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">  roles.add(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(principal))&#123;</span><br><span class="line">    roles.add(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.创建返回值对象，并设置其roles属性。</span></span><br><span class="line">  SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo(roles);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>效果：当登录用户为admin时，两个页面都能访问。当登录用户为user时，只能访问user.jsp页面，访问另一个页面时会跳转到unauthorized.jsp页面。unauthorized.jsp页面意为没有权限访问的页面。</li>
</ul>
</li>
</ul>
<h2 id="Shiro标签"><a href="#Shiro标签" class="headerlink" title="Shiro标签"></a>Shiro标签</h2><ul>
<li><p>Shiro 提供了 JSTL 标签用于在 JSP 页面进行权限控制，如根据登录用户显示相应的页面按钮。 </p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=<span class="string">&quot;shiro&quot;</span> uri=<span class="string">&quot;http://shiro.apache.org/tags&quot;</span> %&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>guest 标签：用户<strong>没有身份验证时</strong>显示相应信息，即游客访问信息：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:guest&gt;</span><br><span class="line">  欢迎游客访问，&lt;a href=&quot;/login.jsp&quot;&gt;登录&lt;/a&gt;</span><br><span class="line">&lt;/shiro:guest&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>user 标签：用户已经<strong>经过认证/记住我登录</strong>后显示相应的信息。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:user&gt;</span><br><span class="line">  欢迎[&lt;shiro:principal/&gt;]登录，&lt;a href=&quot;shiroLogout&quot;&gt;登出&lt;/a&gt;</span><br><span class="line">&lt;/shiro:user&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>authenticated 标签：用户已经身份验证通过，即Subject.login登录成功，<strong>不是记住我登录的</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:authenticated&gt;</span><br><span class="line">  用户[&lt;shiro:principal/&gt;]已身份验证通过</span><br><span class="line">&lt;/shiro:authenticated&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>notAuthenticated 标签：用户未进行身份验证，即<strong>没有调用Subject.login进行登录</strong>，<strong>包括记住我自动登录的也属于未进行身份验证</strong>。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:notAuthenticated&gt;</span><br><span class="line">  未验证身份(包括记住我登录的)</span><br><span class="line">&lt;/shiro:notAuthenticated&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>pincipal 标签：<strong>显示用户身份信息</strong>，默认调用Subject.getPrincipal() 获取，即 Primary Principal。</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%--当为一个实体类对象时，使用property可以显示的指明要显示哪一个--%&gt;</span><br><span class="line">&lt;shiro:principal property=<span class="string">&quot;username&quot;</span>/&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>hasRole 标签：如果当前 Subject 有角色将显示 body 体内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:hasRole name=<span class="string">&quot;admin&quot;</span>&gt;</span><br><span class="line">  用户[&lt;shiro:principal/&gt;]拥有角色admin&lt;br&gt;</span><br><span class="line">&lt;/shiro:hasRole&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>hasAnyRoles 标签：如果当前Subject有任意一个角色（或的关系）将显示body体内容</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:hasAnyRoles name=<span class="string">&quot;admin,user&quot;</span>&gt;</span><br><span class="line">  用户[&lt;shiro:principal/&gt;]拥有角色admin或user&lt;br&gt;</span><br><span class="line">&lt;/shiro:hasAnyRoles&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>lacksRole：如果当前 Subject 没有角色将显示 body 体内容</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:lacksRole name=<span class="string">&quot;admin&quot;</span>&gt;</span><br><span class="line">  用户[&lt;shiro:principal/&gt;]没有角色admin&lt;br&gt;</span><br><span class="line">&lt;/shiro:lacksRole&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>hasPermission：如果当前 Subject 有权限将显示 body 体内容</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:hasPermission name=<span class="string">&quot;user:create&quot;</span>&gt;</span><br><span class="line">  用户[&lt;shiro:principal/&gt;]拥有权限user:create&lt;br&gt;</span><br><span class="line">&lt;/shiro:hasPermission&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>lacksPermission：如果当前Subject没有权限将显示body体内容。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:lacksPermission name=<span class="string">&quot;user:create&quot;</span>&gt;</span><br><span class="line">  用户[&lt;shiro:principal/&gt;]没有权限user:create&lt;br&gt;</span><br><span class="line">&lt;/shiro:lacksPermission&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="权限注解"><a href="#权限注解" class="headerlink" title="权限注解"></a>权限注解</h2><ul>
<li>权限注解：表示为此方法执行需要当前用户具有什么权限。</li>
<li>@RequiresAuthentication：表示当前Subject已经通过login 进行了身份验证；<strong>即 Subject. isAuthenticated() 返回 true</strong>。</li>
<li>@RequiresUser：表示当前 Subject 已经<strong>身份验证或者通过记住我登录的</strong>。 </li>
<li>@RequiresGuest：表示当前Subject没有身份验证或通过记住我登录过，即是<strong>游客身份</strong>。</li>
<li>@RequiresRoles(value={“admin”, “user”}, logical= Logical.AND)：表示当前 Subject <strong>需要角色</strong> admin 和user</li>
<li>@RequiresPermissions (value={“user:a”, “user:b”}, logical= Logical.OR)：表示当前 Subject <strong>需要权限</strong> user:a 或user:b。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//表示当前testShiro()方法只有admin角色的用户才能访问。</span></span><br><span class="line"><span class="meta">@RequiresRoles(value = &#123;&quot;admin&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testShiro</span><span class="params">()</span></span>&#123;</span><br><span class="line">  System.out.println(<span class="keyword">new</span> Date().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当没有权限的用户访问此方法时会抛出org.apache.shiro.authz.UnauthorizedException异常。<ul>
<li>此时就可以使用Spring的声明时异常处理，将此异常转到一个错误页面即可。</li>
</ul>
</li>
<li>此注解既可以用在Handler层，也可以用在service层。<ul>
<li>但是service层代码一般都会加事务注解，让service层的类生成代理类。此时在加上权限注解，有可能出现类型转换异常。</li>
<li>因此。权限注解建议添加在handler层，即控制层。</li>
</ul>
</li>
</ul>
<h2 id="自定义拦截器"><a href="#自定义拦截器" class="headerlink" title="自定义拦截器"></a>自定义拦截器</h2><ul>
<li><p>通过自定义拦截器可以扩展功能，例如：动态url-角色/权限访问控制的实现、根据 Subject 身份信息获取用户信息绑定到 Request（即设置通用数据）、验证码验证、在线用户信息的保存等。</p>
</li>
<li><p>配置自定义拦截器，就可以将配置文件中的拦截规则动态的添加。</p>
</li>
<li><p>步骤：</p>
<ul>
<li>第一步：配置文件中注释调拦截规则，配置filterChainDefinitionMap属性。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;shiroFilter&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.spring.web.ShiroFilterFactoryBean&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;securityManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;securityManager&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;loginUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/login.jsp&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;successUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/list.jsp&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;unauthorizedUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/unauthorized.jsp&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--通过设置此属性来动态的添加映射规则。此属性实际上是一个map--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filterChainDefinitionMap&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;filterChainDefinitionMap&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--   &lt;property name=&quot;filterChainDefinitions&quot;&gt;</span></span><br><span class="line"><span class="comment">      &lt;value&gt;</span></span><br><span class="line"><span class="comment">        /login.jsp = anon</span></span><br><span class="line"><span class="comment">        /shiroLogin = anon</span></span><br><span class="line"><span class="comment">        /shiroLogout = logout</span></span><br><span class="line"><span class="comment">        /user.jsp = roles[user]</span></span><br><span class="line"><span class="comment">        /admin.jsp = roles[admin]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        /** = authc</span></span><br><span class="line"><span class="comment">      &lt;/value&gt;</span></span><br><span class="line"><span class="comment">    &lt;/property&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第二步：创建自定义拦截器。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterChainDefinitionMapBuilder</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> LinkedHashMap&lt;String,String&gt; <span class="title">builderFilterChainDefinitionMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LinkedHashMap&lt;String,String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//在此处定义拦截规则。此处的添加的顺序按照优先匹配原则</span></span><br><span class="line">    filterChainDefinitionMap.put(<span class="string">&quot;/login.jsp&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    filterChainDefinitionMap.put(<span class="string">&quot;/shiroLogin&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    filterChainDefinitionMap.put(<span class="string">&quot;/shiroLogout&quot;</span>, <span class="string">&quot;logout&quot;</span>);</span><br><span class="line">    filterChainDefinitionMap.put(<span class="string">&quot;/user.jsp&quot;</span>, <span class="string">&quot;roles[user]&quot;</span>);</span><br><span class="line">    filterChainDefinitionMap.put(<span class="string">&quot;/admin.jsp&quot;</span>, <span class="string">&quot;roles[admin]&quot;</span>);</span><br><span class="line">    filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> filterChainDefinitionMap;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第三步：配置自定义拦截器到filterChainDefinitionMap属性。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置filterChainDefinitionMap的bean。其值通过实例工厂的方式进行注入--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;filterChainDefinitionMap&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;filterChainDefinitionMapBuilder&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;builderFilterChainDefinitionMap&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;filterChainDefinitionMapBuilder&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.lc.bean.builders.FilterChainDefinitionMapBuilder&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a>会话管理</h1><ul>
<li><p>Shiro 提供了完整的企业级会话管理功能，<strong>不依赖于底层容器</strong>（如web容器tomcat），<strong>不管 JavaSE 还是 JavaEE 环境都可以使用</strong>，提供了会话管理、会话事件监听、会话存储/持久化、容器无关的集群、失效/过期支持、对Web 的透明支持、SSO 单点登录的支持等特性。</p>
</li>
<li><p>会话相关的API</p>
<ul>
<li>Subject.getSession()：即可获取会话；<ul>
<li>其等价于Subject.getSession(true)，即如果当前没有创建 Session 对象会创建一个；</li>
<li>Subject.getSession(false)，如果当前没有创建 Session 则返回null</li>
</ul>
</li>
<li>session.getId()：获取当前会话的唯一标识</li>
<li>session.getHost()：获取当前Subject的主机地址</li>
<li>session.getTimeout() &amp; session.setTimeout(毫秒)：获取/设置当前Session的过期时间</li>
<li>session.getStartTimestamp() &amp; session.getLastAccessTime()：获取会话的启动时间及最后访问时间；<ul>
<li>如果是 JavaSE 应用需要自己定期调用 session.touch() 去更新最后访问时间；</li>
<li>如果是 Web 应用，每次进入 ShiroFilter 都会自动调用 session.touch() 来更新最后访问时间。</li>
</ul>
</li>
<li>session.touch() &amp; session.stop()：更新会话最后访问时间及销毁会话；当Subject.logout()时会自动调用 stop 方法来销毁会话。如果在web中，调用 HttpSession. invalidate() 也会自动调用Shiro Session.stop 方法进行销毁Shiro 的会 话</li>
<li>session.setAttribute(key, val) &amp; session.getAttribute(key) &amp; session.removeAttribute(key)：<ul>
<li>设置/获取/删除会话属性；在整个会话范围内都可以对这些属性进行操作</li>
</ul>
</li>
</ul>
</li>
<li><p>会话监听器用于监听会话创建、过期及停止事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SessionListener</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Session var1)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onStop</span><span class="params">(Session var1)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onExpiration</span><span class="params">(Session var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Shiro的Session的应用：</p>
<ul>
<li>在handler层伪码一般都是用HttpSession。如果在service层也想使用Session。此时就可以使用Shiro的Session.</li>
<li>对于没有服务器的项目即SE项目，Shiro可以提供Session的使用。</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testAnnotation&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testAnnotation</span><span class="params">(HttpSession session)</span></span>&#123;</span><br><span class="line">  session.setAttribute(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;1234&quot;</span>);</span><br><span class="line">  shiroService.testShiro();</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;main&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroService</span> </span>&#123;</span><br><span class="line">  <span class="comment">//表示当前testShiro()方法只有admin角色的用户才能访问。</span></span><br><span class="line">  <span class="meta">@RequiresRoles(value = &#123;&quot;admin&quot;&#125;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testShiro</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="keyword">new</span> Date().toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过Subject获取的Shiro的Session可以拿到在HttpSession中的数据</span></span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line">    Session session = subject.getSession();</span><br><span class="line">    Object key = session.getAttribute(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    System.out.println(key); <span class="comment">//此时输出的是1234</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="SessionDao"><a href="#SessionDao" class="headerlink" title="SessionDao"></a>SessionDao</h2><ul>
<li><p>SessionDao的目的是将Session保存在数据库中，并以此对Session进行CRUD操作。</p>
</li>
<li><p>SessionDao的继承树：</p>
<p><img src="https://gitee.com/plumChuan/picture-bed/raw/master/img/20210530171033-1.png"></p>
<ul>
<li>AbstractSessionDAO 提供了 SessionDAO 的<strong>基础实现</strong>，如生成会话ID等 。</li>
<li>CachingSessionDAO 提供了对开发者透明的<strong>会话缓存的功能</strong>，需要设置相应的 CacheManager</li>
<li>MemorySessionDAO 直接在<strong>内存中进行会话维护</strong>。</li>
<li>EnterpriseCacheSessionDAO 提供了缓存功能的会话维护，<strong>默认情况下使用 MapCache 实现</strong>，内部使用<strong>ConcurrentHashMap 保存缓存的会话</strong>。</li>
</ul>
</li>
<li><p>SessionDao的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SessionDao的配置。最终的sessionManager需要注入到securityManager中--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--************************************************--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Session ID生成器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sessionIdGenerator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.session.mgt.eis.JavaUuidSessionIdGenerator&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--Session Dao 继承EnterpriseCacheSessionDAO--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sessionDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.lc.bean.daos.MySessionDao&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--使用的缓存策略。比如这里使用Ehcache的一个缓存配置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;activeSessionsCacheName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;shiro-ActiveSessionsCache&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionIdGenerator&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sessionIdGenerator&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--Session管理器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sessionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.session.mgt.DefaultSessionManager&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;globalSessionTimeout&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100000&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;deleteInvalidSessions&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionValidationSchedulerEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionDAO&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sessionDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--************************************************--&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>缓存的配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Session Dao的缓存策略--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">&quot;shrio-ActiveSessionsCache&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">maxEntriesLocalHeap</span>=<span class="string">&quot;10000&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">overflowToDisk</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">enternal</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">diskPersistent</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">timeToLiveSeconds</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">statistics</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>自定义的SessionDao</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySessionDao</span> <span class="keyword">extends</span> <span class="title">EnterpriseCacheSessionDAO</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Serializable <span class="title">doCreate</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">    Serializable sessionId = <span class="keyword">super</span>.doCreate(session);</span><br><span class="line"></span><br><span class="line">    String sql = <span class="string">&quot;insert into sessions(id,session) values(?,?)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    jdbcTemplate.update(sql,sessionId, SerializableUtils.serialize(session));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session.getId();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Session <span class="title">doReadSession</span><span class="params">(Serializable sessionId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String sql = <span class="string">&quot;select session from sessions where id=?&quot;</span>;</span><br><span class="line">    List&lt;String&gt; sessionList = jdbcTemplate.queryForList(sql,String.class,sessionId);</span><br><span class="line">    <span class="keyword">if</span> (sessionList.size() == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SerializableUtils.deserialize(sessionList.get(<span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doUpdate</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (session <span class="keyword">instanceof</span> ValidatingSession &amp;&amp; !((ValidatingSession)session).isValid())&#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String sql = <span class="string">&quot;update sessions set session=? where id=?&quot;</span>;</span><br><span class="line">    jdbcTemplate.update(sql,SerializableUtils.serialize(session),session.getId());</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDelete</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">    String sql = <span class="string">&quot;delete from sessions where id=?&quot;</span>;</span><br><span class="line">    jdbcTemplate.update(sql,session.getId());</span><br><span class="line">    <span class="keyword">super</span>.doDelete(session);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对应的数据表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table sessions (</span><br><span class="line">  id varchar(200),</span><br><span class="line">  session varchar(2000), # 长文本</span><br><span class="line">  constraint pk_sessions primary key(id)</span><br><span class="line">) charset&#x3D;utf8 ENGINE&#x3D;InnoDB;</span><br></pre></td></tr></table></figure>

<ul>
<li>对应的工具类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializableUtils</span> </span>&#123;</span><br><span class="line">  <span class="comment">//将Session对象序列化</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">serialize</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">    ByteArrayOutputStream baos = <span class="keyword">null</span>;</span><br><span class="line">    ObjectOutputStream oos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">      oos = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line">      oos.writeObject(session);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Base64.encodeToString(baos.toByteArray());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//将Session对象反序列化</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Session <span class="title">deserialize</span><span class="params">(String sessionStr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ByteArrayInputStream bais = <span class="keyword">null</span>;</span><br><span class="line">      bais = <span class="keyword">new</span> ByteArrayInputStream(Base64.decode(sessionStr));</span><br><span class="line">      ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</span><br><span class="line">      <span class="keyword">return</span> (Session) ois.readObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Session验证"><a href="#Session验证" class="headerlink" title="Session验证"></a>Session验证</h2><ul>
<li>Shiro 提供了<strong>会话验证调度器，用于定期的验证会话是否已过期</strong>，如果过期将停止会话。</li>
<li>出于性能考虑，一般情况下都是获取会话时来验证会话是否过期并停止会话的；但是如在 <strong>web 环境中</strong>，如果用户不主动退出是不知道会话是否过期的，因此需要定期的检测会话是否过期，Shiro 提供了会话验证调度器<strong>SessionValidationScheduler</strong>。</li>
<li>Shiro 也提供了使用Quartz会话验证调度器：<strong>QuartzSessionValidationScheduler</strong>。</li>
<li>会话验证需要单独开线程进行验证，可能会占用CPU。</li>
</ul>
<h1 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h1><ul>
<li>CacheManagerAware 接口：<ul>
<li>Shiro 内部相应的组件（DefaultSecurityManager）会自动检测相应的对象（如Realm）<strong>是否实现了CacheManagerAware 并自动注入相应的CacheManager</strong>。</li>
</ul>
</li>
<li>Realm 缓存：<ul>
<li>Shiro 提供了 CachingRealm，其实现了CacheManagerAware 接口，提供了缓存的一些基础实现；</li>
<li><strong>AuthenticatingRealm 及 AuthorizingRealm</strong> 也分别提供了对AuthenticationInfo 和 AuthorizationInfo 信息的缓存。</li>
</ul>
</li>
<li>Session 缓存：<ul>
<li>如 SecurityManager 实现了 SessionSecurityManager， 其会判断 SessionManager 是否实现了CacheManagerAware 接口，如果实现了会把CacheManager 设置给它。 </li>
<li>SessionManager 也会判断相应的 SessionDAO（如继承自CachingSessionDAO）是否实现了<br>CacheManagerAware，如果实现了会把 CacheManager设置给它 。</li>
<li>设置了缓存的 SessionManager，查询时会先查缓存，如果找不到才查数据库。</li>
</ul>
</li>
</ul>
<h1 id="RememberMe"><a href="#RememberMe" class="headerlink" title="RememberMe"></a>RememberMe</h1><ul>
<li><p>Shiro 提供了记住我（RememberMe）的功能，比如访问如淘宝等一些网站时，关闭了浏览器，下次再打开时还是能记住你是谁，下次访问时无需再登录即可访问，基本流程如下：</p>
<ul>
<li>1、首先在登录页面选中 RememberMe 然后登录成功；如果是浏览器登录，一般会把 RememberMe 的Cookie 写到客户端并保存下来； </li>
<li>2、关闭浏览器再重新打开；会发现浏览器还是记住你的；</li>
<li>3、访问一般的网页服务器端还是知道你是谁，且能正常访问；</li>
<li>4、但是比如我们访问淘宝时，如果要查看我的订单或进行支付时，此时还是需要再进行身份认证的，以确保当前用户还是你。</li>
</ul>
</li>
<li><p>认证和记住我的区别：</p>
<ul>
<li>subject.isAuthenticated() 表示用户进行了<strong>身份验证登录</strong>的，即使有 <strong>Subject.login</strong> 进行了登录；</li>
<li>subject.isRemembered()：表示用户是<strong>通过记住我登录</strong>的，此时<strong>可能并不是真正的你</strong>（如你的朋友使用你的电脑，或者你的cookie 被窃取）在访问的。</li>
<li><strong>两者二选一</strong>，即 subject.isAuthenticated()==true，则subject.isRemembered()==false；反之一样。</li>
</ul>
</li>
<li><p>建议：</p>
<ul>
<li><strong>访问一般网页</strong>：如<strong>个人在主页之类的，我们使用user 拦截器即可</strong>，user 拦截器只要用户登录<br>(isRemembered() || isAuthenticated())过即可访问成功；</li>
<li><strong>访问特殊网页</strong>：如我的订单，<strong>提交订单页面，我们使用authc 拦截器即可</strong>，authc 拦截器会判断用户是否是通过Subject.login（isAuthenticated()==true）登录的，如果是才放行，否则会跳转到登录页面叫你重新登录。</li>
</ul>
</li>
<li><p>实现：</p>
<ul>
<li>如果要自己做RememeberMe，需要在登录之前这样创建TokenUsernamePasswordToken(用户名，密码，是否记住我)，且调用UsernamePasswordToken 的：<strong>token.setRememberMe(true);</strong> 方法</li>
<li>修改过滤规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对于user.jsp，admin.jsp页面，需要认证后才能访问</span></span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/user.jsp&quot;</span>, <span class="string">&quot;authc,roles[user]&quot;</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/admin.jsp&quot;</span>, <span class="string">&quot;authc,roles[admin]&quot;</span>);</span><br><span class="line"><span class="comment">//对于list.jsp页面，只要登录就能访问</span></span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/list.jsp&quot;</span>, <span class="string">&quot;user&quot;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>对于记住我的设置：</p>
<ul>
<li>方式一：在securityManager中直接设置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;securityManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.web.mgt.DefaultWebSecurityManager&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cacheManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;cacheManager&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;authenticator&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;authenticator&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;realms&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;shiroRealm&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;secondRealm&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sessionManager&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--设置cookie的有效期 单位：秒--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;rememberMeManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.web.mgt.CookieRememberMeManager&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cookie.maxAge&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>方式二：设置Cookie的管理器。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;securityManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.web.mgt.DefaultWebSecurityManager&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cacheManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;cacheManager&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;authenticator&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;authenticator&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;realms&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;shiroRealm&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;secondRealm&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sessionManager&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;rememberMeManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;rememberMeManager&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--对于记住我的Cookie的时效的设置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;cookie&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.web.servlet.SimpleCookie&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--cookie的名字的设置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;remembeeeeerMe&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;httpOnly&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--30天--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxAge&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2592000&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--rememberMe管理器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;rememberMeManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.shiro.web.mgt.CookieRememberMeManager&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cipherKey&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;T(org.apache.shiro.codec.Base64).decode(&#x27;4AvVhmFLUs0KTA3Kprsdag&#x27;)&#125;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cookie&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;cookie&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>

    </div>

    
    
    


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/05/22/%E5%B0%9A%E7%A1%85%E8%B0%B7%E8%AF%B4Java/%E9%A1%B9%E7%9B%AE/sssp%E6%95%B4%E5%90%88/" rel="prev" title="SSSP整合">
      <i class="fa fa-chevron-left"></i> SSSP整合
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/02/%E5%B0%9A%E7%A1%85%E8%B0%B7%E8%AF%B4Java/%E9%9B%86%E6%88%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/Git%E5%92%8C%E5%85%B6%E8%A1%8D%E7%94%9F%E4%BA%A7%E5%93%81/" rel="next" title="Git和其衍生产品">
      Git和其衍生产品 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD"><span class="nav-number">1.1.</span> <span class="nav-text">基本功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84-%E4%BB%8E%E5%A4%96%E9%83%A8%E6%96%B9%E5%90%91"><span class="nav-number">1.2.</span> <span class="nav-text">架构(从外部方向)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84-%E4%BB%8E%E5%86%85%E9%83%A8%E6%96%B9%E5%90%91"><span class="nav-number">1.3.</span> <span class="nav-text">架构(从内部方向)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HelloWorld"><span class="nav-number">2.</span> <span class="nav-text">HelloWorld</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E6%88%90Spring"><span class="nav-number">3.</span> <span class="nav-text">集成Spring</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ShiroFilter"><span class="nav-number">4.</span> <span class="nav-text">ShiroFilter</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD"><span class="nav-number">5.</span> <span class="nav-text">认证功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="nav-number">5.1.</span> <span class="nav-text">身份认证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E7%9A%84%E6%AF%94%E5%AF%B9"><span class="nav-number">5.2.</span> <span class="nav-text">密码的比对</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9ARealm%E6%97%B6%E7%9A%84%E9%AA%8C%E8%AF%81"><span class="nav-number">5.3.</span> <span class="nav-text">多Realm时的验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E5%8A%9F%E8%83%BD"><span class="nav-number">6.</span> <span class="nav-text">授权功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E5%8A%9F%E8%83%BD-1"><span class="nav-number">6.1.</span> <span class="nav-text">授权功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shiro%E6%A0%87%E7%AD%BE"><span class="nav-number">6.2.</span> <span class="nav-text">Shiro标签</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%B3%A8%E8%A7%A3"><span class="nav-number">6.3.</span> <span class="nav-text">权限注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">6.4.</span> <span class="nav-text">自定义拦截器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86"><span class="nav-number">7.</span> <span class="nav-text">会话管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SessionDao"><span class="nav-number">7.1.</span> <span class="nav-text">SessionDao</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Session%E9%AA%8C%E8%AF%81"><span class="nav-number">7.2.</span> <span class="nav-text">Session验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%93%E5%AD%98"><span class="nav-number">8.</span> <span class="nav-text">缓存</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RememberMe"><span class="nav-number">9.</span> <span class="nav-text">RememberMe</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Plum Reiver</p>
  <div class="site-description" itemprop="description">技术，日常，笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">91</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
	
  </nav>
</div>


      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Plum Reiver</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
